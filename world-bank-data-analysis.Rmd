---
title: "World Development Indicators and Gold Price Data Analysis"
author: "Adrian Glapi≈Ñski"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output: 
  html_document: 
    keep_md: false
    df_print: kable
    code_folding: "hide"
    toc: true
    toc_float: true
    number_sections: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Executive summary
TODO

## Libraries used
Following libraries and dependencies were used in the report:
 - `knitr`
 - `kableExtra`
 - `DT`
 - `tidyverse`
 - `readxl`
 - `janitor`
 - `lubridate`
 - `skimr`
 - `corrr`
 - `ggplot2`
 - `ggthemes`
 - `gganimate`
 - `ggcorrplot`
 - `plotly`
 - `caret`
 - `missForest`
 - `countrycode`

```{r load-libraries, message=FALSE}
#class.source="fold-show"
library(knitr)

library(kableExtra)
library(DT)

library(tidyverse)
library(readxl)
library(janitor)

library(lubridate)

library(skimr)

library(corrr)

library(ggplot2)
library(ggthemes)
library(gganimate)
library(ggcorrplot)
library(plotly)

library(caret)
library(missForest)

library(countrycode)
```

## Loading data
The input data includes information on the economic indicators and 
development of each country as measured by over 200 statistics. In addition, 
it includes information on currency exchange rates, gold prices, 
Bitcoin trading, and the monthly performance of the S&P Composite. 

The data was collected by various institutions, 
notably the World Bank and Nasdaq.

```{r load-data, message=FALSE}
# https://data.worldbank.org/
wdi_df <- read_excel('./data/World_Development_Indicators.xlsx', 
                     na = c('', '..')) %>% head(-5)

currency_df <- read_csv('./data/CurrencyExchangeRates.csv', 
                        col_types = cols(Date = col_date("%Y-%m-%d")))

# https://data.nasdaq.com/data/LBMA/GOLD-gold-price-london-fixing
gold_prices_df <- read_csv('./data/Gold prices.csv')

# https://data.nasdaq.com/data/YALE/SPCOMP-sp-composite
sp_df <- read_csv('./data/S&P Composite.csv')

# https://data.nasdaq.com/data/BCHAIN-blockchain
btc_diff_df <- read_csv('./data/bitcoin/BCHAIN-DIFF.csv')
btc_hrate_df <- read_csv('./data/bitcoin/BCHAIN-HRATE.csv')
btc_mkpru_df <- read_csv('./data/bitcoin/BCHAIN-MKPRU.csv')
btc_trvou_df <- read_csv('./data/bitcoin/BCHAIN-TRVOU.csv')
```

## Cleaning data sets
While cleaning each data set, decisions described below were made.

### World Development Indicators
1. `Country Code` and `Series Code` columns were dropped
2. All columns except `Country Name` and `Series Name` were pivoted into 
longer format; names of columns were stored into `Year` column 
3. All columns were pivoted into wider format, taking column names from 
`Series Name` column
4. `Country Name` column was mutated into column of `factor` type and 
`Year` column was mutated into column of `numeric` type
5. Column names were cleaned - all words were transformed into `snake_case`
```{r clean-wdi-data-set}
wdi_cleaned_df <- wdi_df %>%
  select(-c(`Country Code`, `Series Code`)) %>%
  pivot_longer(-c(`Country Name`, `Series Name`), names_to = 'Year') %>%
  pivot_wider(names_from = `Series Name`) %>%
  mutate(`Country Name` = as_factor(`Country Name`),
         Year = as.numeric(word(Year))) 
wdi_names <- names(wdi_cleaned_df) %>% 
  set_names(make_clean_names(.)) %>%
  as.list
wdi_cleaned_df <- set_names(wdi_cleaned_df, names(wdi_names))
```

### Currency Exchange Rates
1. All columns except `Date` were pivoted into longer format; names of columns
were stored into `currency` column, values were stored into `exchange_rate` 
column
2. Column names were cleaned - all words were transformed into `snake_case`
3. `currency` column was mutated into column of `factor` type
```{r clean-currency-data-set}
currency_df <- currency_df %>%
  pivot_longer(cols = -Date, names_to = 'currency',
               values_to = 'exchange_rate') %>%
  clean_names() %>%
  mutate(currency = as_factor(currency))
```

### Gold prices
1. Column names were cleaned - all words were transformed into `snake_case`
```{r clean-gold-prices-data-set}
gold_prices_df <- clean_names(gold_prices_df)
```

### S&P Composite
1. Column names were cleaned - all words were transformed into `snake_case`
2. `year` column was renamed to `date`
```{r clean-sp-composite-data-set}
sp_df <- clean_names(sp_df) %>% rename(date = year)
```

### Bitcoin
1. Column names were cleaned - all words were transformed into `snake_case`
2. All data frames loaded from CSV files were joined into one data frame
3. Following columns were renamed:
    - `value_diff` to `difficulty`
    - `value_hrate` to `hash_rate`
    - `value_mkpru` to `market_price_usd`
    - `value_trvou` to `exchange_trade_volume_usd`
```{r clean-btc-data-set}
btc_diff_df <- clean_names(btc_diff_df)
btc_hrate_df <- clean_names(btc_hrate_df)
btc_mkpru_df <- clean_names(btc_mkpru_df)
btc_trvou_df <- clean_names(btc_trvou_df)

btc_df <- btc_diff_df %>%
  full_join(btc_hrate_df, by = 'date', suffix = c('_diff', '_hrate')) %>%
  full_join(btc_mkpru_df, by = 'date') %>% 
  full_join(btc_trvou_df, by = 'date', suffix = c('_mkpru', '_trvou')) %>%
  rename(difficulty = value_diff,
         hash_rate = value_hrate,
         market_price_usd = value_mkpru,
         exchange_trade_volume_usd = value_trvou)
```

## Cleaned data set summary
In this section, summary with basic statistics for each of the data sets 
and their variables was presented. 
```{r data-set-summary}
tribble(
  ~Table, ~`No. of columns (attributes)`, ~`No. of rows (observations)`,
  'World Development Indicators', ncol(wdi_cleaned_df), nrow(wdi_cleaned_df),
  'Currency Exchange Rates', ncol(currency_df), nrow(currency_df),
  'Gold prices', ncol(gold_prices_df), nrow(gold_prices_df),
  'S&P Composite', ncol(sp_df), nrow(sp_df),
  'Bitcoin', ncol(btc_df), nrow(btc_df)
) %>% kbl() %>% kable_styling()
```

### World Development Indicators
```{r wdi-summary}
wdi_skim_df <- wdi_cleaned_df %>% 
  set_names(wdi_names) %>%
  skim() 
wdi_skim_df %>%
  yank('factor') %>% 
  clean_names(case = 'title') %>%
  datatable(options = list(scrollX = TRUE))
wdi_skim_df %>%
  yank('numeric') %>% 
  clean_names(case = 'title') %>%
  datatable(options = list(scrollX = TRUE)) %>% 
  formatRound(3:10)
```

### Currency Exchange Rates
```{r currency-summary}
currency_df %>% 
  clean_names(case = 'title') %>%
  skim() %>% 
  clean_names(case = 'title') %>%
  datatable(options = list(scrollX = TRUE)) %>% 
  formatRound(c(4:6, 8, 10:15))
```
A closer look at the data in `Currency Exchange Rates` data set reveals 
ambiguity whether currency exchange rates are from given currency to U.S. Dollar
or vice versa. By looking at exchange rate for Polish Zloty, we can deduce that
exchange rates in the data set are from U.S. Dollar to Polish Zloty.
On the other side, looking at exchange rates of Euro or U.K. Pound Sterling
suggests that the conversion in these cases is reverse; it is common knowledge
that Euro and U.K. Pound Sterling are more valuable currencies than U.S. Dollar, 
so their exchange rate should be below `1.0`, but it isn't.
Therefore, **whole data set was discarded from further analysis**.

```{r}
currency_df %>% 
  filter(currency %in% c('Polish Zloty', 'U.K. Pound Sterling', 'Euro',
                         'U.S. Dollar')) %>% 
  group_by(date) %>% 
  filter(all(!is.na(exchange_rate))) %>% 
  tail(4) %>% 
  clean_names(case = 'title') %>% 
  kbl() %>% kable_styling()
```

### Gold prices
```{r gold-prices-summary}
gold_prices_df %>% 
  clean_names(case = 'title', abbreviations = c('USD', 'GBP', 'AM', 'PM')) %>%
  skim() %>%
  clean_names(case = 'title') %>%
  datatable(options = list(scrollX = TRUE)) %>% 
  formatRound(4:14)
```

### S&P Composite
```{r sp-composite-summary}
sp_df %>% 
  clean_names(case = 'title', abbreviations = c('CPI')) %>% 
  rename(`S&P Composite` = `S p Composite`) %>%
  skim() %>% 
  clean_names(case = 'title') %>%
  datatable(options = list(scrollX = TRUE)) %>% 
  formatRound(4:15)
```

### Bitcoin
```{r bitcoin-summary}
btc_df %>% 
  clean_names(case = 'title', abbreviations = c('USD')) %>%
  skim() %>%
  clean_names(case = 'title') %>%
  datatable(options = list(scrollX = TRUE)) %>% 
  formatRound(4:15)
```

## Finding correlations
Correlations between World Development Indicators were presented on the 
interactive correlation heat map below. **Only variables with more than 75%** 
**complete rate (less than 25% of `NA` values) were selected**.

Hover over cells in the matrix to show correlated variables names 
and their correlation values.

```{r wdi-correlations}
wdi_na_filtered_df <- wdi_cleaned_df %>%
  set_names(wdi_names) %>%
  select(where(~mean(is.na(.)) < 0.25))

corr_plot <- wdi_na_filtered_df %>%
  select(3:last_col()) %>%
  cor(use = 'pairwise.complete.obs') %>% 
  ggcorrplot() +
  labs(x = 'Variable 1', y = 'Variable 2') + 
  theme_classic() +
  theme(axis.text = element_blank(), axis.ticks = element_blank()) 

ggplotly(corr_plot)
```

### GDP per capita
Per capita gross domestic product (GDP) measures a country's economic output per
person and is calculated by dividing the GDP of a country by its population.
Per capita GDP is a global measure for gauging the prosperity of nations and 
to analyze the prosperity of a country based on its economic growth.

```{r gdp-per-capita-map-plot, out.width='100%'}
wdi_map_df <- wdi_cleaned_df %>% 
  filter(!country_name %in% c('Channel Islands', 'Kosovo', 
                              'Low & middle income', 'Low income', 
                              'Lower middle income', 'Middle income', 'World',
                              'Upper middle income', 'High income')) 

wdi_map_df %>%
  rename(`GDP per capita (USD)` = gdp_per_capita_current_us) %>%
  plot_geo(locationmode = 'country names') %>%
  add_trace(z = ~`GDP per capita (USD)`, zmin = 0, zmax = 70000, 
            color = ~`GDP per capita (USD)`,
            frame = ~year, 
            colors = 'Blues',
            text = ~country_name,
            locations = ~country_name,
            marker = list(line = list(color = toRGB("grey"), width = 0.5))) %>%
  colorbar(title = 'GDP per capita (USD)') %>% 
  layout(title = 'GDP per capita over years',
         geo = list(scope = 'world',
                    projection = list(type = 'natural earth'),
                    countrycolor = toRGB('grey'),
                    showcoastlines = TRUE)) %>%  
  animation_opts(redraw = FALSE) %>%  
  plotly_build()
```

#### Correlation between GDP per capita and life expectancy
Inspired by the [The Intimate Link between Income Levels and Life Expectancy: 
Global Evidence from 213 Years](https://docs.iza.org/dp10015.pdf) discussion 
paper, correlation between GDP per capita and life expectancy was explored. 

The first plot presents how GDP per capita and life expectancy changed over
years in countries grouped by continents. High positive correlation can be 
deduced by observing the animation, which is confirmed by the following map 
plot.
```{r gdp-per-capita-life-expectancy-cor, out.width='100%'}
wdi_continents_df <- wdi_map_df %>%
  add_column(continent = countrycode(sourcevar = .$country_name,
                                     origin = "country.name",
                                     destination = "continent")) %>%
  relocate(continent)

wdi_continents_df %>%
  ggplot(aes(gdp_per_capita_current_us, 
             life_expectancy_at_birth_total_years, 
             size = population_total, 
             color = continent)) +
  geom_point(alpha = 0.7) +
  scale_size_continuous(name = "Population",
                        breaks = c(1e9, 1e8, 1e7, 1e6),
                        limits = c(1e6, 1e9),
                        range = c(1, 8)) +
  scale_x_log10(labels = scales::comma) +
  theme_bw(base_size = 8) +
  labs(title = "Year: {round(frame_time)}", 
       x = 'GDP per capita (USD)',
       y = 'Life expectancy (years)', 
       color = "Continent",
       caption = "") +
  transition_time(year) +
  ease_aes('linear') 

wdi_life_expectancy_cor_df <- wdi_map_df %>% 
  group_by(country_name) %>%
  summarize(correlation = cor(gdp_per_capita_current_us,
                              life_expectancy_at_birth_total_years, 
                              use = 'pairwise.complete.obs'))

wdi_life_expectancy_cor_df %>%
  plot_geo(locationmode = 'country names') %>%
  add_trace(z = ~correlation, zmin = -1, zmax = 1, 
            color = ~correlation,
            colors = c("blue", "white", "red"),
            text = ~country_name,
            locations = ~country_name,
            marker = list(line = list(color = toRGB("grey"), width = 0.5))) %>%
  colorbar(title = 'Correlation') %>% 
  layout(title = 'GDP per capita (USD) - life expectancy (years) correlation',
         geo = list(scope = 'world',
                    projection = list(type = 'natural earth'),
                    countrycolor = toRGB('grey'),
                    showframe = TRUE,
                    showcoastlines = TRUE)) %>%  
  plotly_build()
```

#### Correlation between GDP per capita and infant mortality rate
To validate that there is a large association between per capita GDP and 
infant mortality rate, as found out by the authors of [Aggregate income shocks and infant mortality in the
developing world](https://openknowledge.worldbank.org/bitstream/handle/10986/4916/rest_a_00084.pdf;sequence=1)
article, the variables change over years 1999-2015 was presented 
in selected countries. 

Once again, high correlation can be deduced from the plots, but this time 
it is negative, which is confirmed by the following map plot. 
```{r gdp-per-capita-mortality-rate-cor, message = FALSE, out.width='100%'}
infmort_plot <- wdi_continents_df %>%
  filter(country_name %in% c("United States", "Tonga", "Colombia", "Grenada", 
                             "Sri Lanka", "Malta", "Germany", "Japan", "Sweden", 
                             "Netherlands"),
         year %in% 1999:2015) %>%
  rename(`GDP per capita (USD)` = gdp_per_capita_current_us,
         `Infant mortality rate (per 1,000 live births)` =
           mortality_rate_infant_per_1_000_live_births,
         Continent = continent,
         Country = country_name) %>%
  ggplot(aes(x = `GDP per capita (USD)`, 
             y = `Infant mortality rate (per 1,000 live births)`,
             color = Continent,
             tooltip = Country)) + 
  geom_point() +
  facet_wrap(~year)

ggplotly(infmort_plot)

wdi_mortality_rate_cor_df <- wdi_map_df %>% 
  group_by(country_name) %>%
  summarize(correlation = cor(gdp_per_capita_current_us,
                              mortality_rate_infant_per_1_000_live_births, 
                              use = 'pairwise.complete.obs'))

wdi_mortality_rate_cor_df %>%
  plot_geo(locationmode = 'country names') %>%
  add_trace(z = ~correlation, zmin = -1, zmax = 1, 
            color = ~correlation,
            colors = c("blue", "white", "red"),
            text = ~country_name,
            locations = ~country_name,
            marker = list(line = list(color = toRGB("grey"), width = 0.5))) %>%
  colorbar(title = 'Correlation') %>% 
  layout(title = 'GDP per capita (USD) - mortality rate, infant (per 1,000 live births) correlation',
         geo = list(scope = 'world',
                    projection = list(type = 'natural earth'),
                    countrycolor = toRGB('grey'),
                    showframe = TRUE,
                    showcoastlines = TRUE)) %>%  
  plotly_build()
```

### Correlation between gold prices and World Development Indicators


Hover over bars in the plot to show correlated variable names 
and their correlation values.
```{r gold-correlation}
yearly_gold_prices_df <- gold_prices_df %>% 
  mutate(date, gold_price_usd = ifelse(is.na(usd_pm), usd_am, usd_pm)) %>%
  group_by(year = year(date)) %>% 
  summarize(gold_price_usd = mean(gold_price_usd))

yearly_sp_df <- sp_df %>% 
  group_by(year = year(date)) %>%
  summarize(sp_composite = mean(s_p_composite))

# Discarded due to lack of data before 2009
#yearly_btc_prices_df <- btc_df %>%
#  group_by(year = year(date)) %>%
#  summarize(btc_price_usd = mean(market_price_usd))

world_joined_df <- wdi_cleaned_df %>%
  filter(country_name == 'World') %>% 
  set_names(wdi_names) %>%
  inner_join(yearly_gold_prices_df, by = c('Year' = 'year')) %>%
  inner_join(yearly_sp_df, by = c('Year' = 'year')) %>%
  rename(`Gold price (USD)` = gold_price_usd,
         `S&P Composite` = sp_composite) %>%
  select(where(~mean(is.na(.)) < 0.25))

world_gold_cor <- world_joined_df %>% 
  select(3:last_col()) %>%
  correlate() %>% 
  focus(`Gold price (USD)`) %>% 
  arrange(desc(abs(`Gold price (USD)`))) %>% 
  filter(abs(`Gold price (USD)`) > 0.6, abs(`Gold price (USD)`) < 0.95) %>%
  rename(`Gold price (USD) correlation` = `Gold price (USD)`,
         Variable = term) 

world_gold_cor_plot <- world_gold_cor %>% 
  ggplot(aes(x = reorder(Variable, `Gold price (USD) correlation`), 
             y = `Gold price (USD) correlation`,
             text = paste('Variable:', Variable,
                          '<br>Gold price (USD) correlation:', 
                          round(`Gold price (USD) correlation`, digits = 5)))) + 
  geom_bar(stat = 'identity') + 
  ylim(-1, 1) +
  labs(x = 'Variable') + 
  theme_minimal() + 
  theme(axis.text.x = element_blank())

ggplotly(world_gold_cor_plot, tooltip = 'text')

datatable(world_gold_cor) %>% formatRound(2, digits = 5)
```

## Gold price regressor
```{r gold-price-regressor} 
set.seed(23)

top_economic_correlated_variables <- world_gold_cor %>%
  pull(Variable) %>%
  .[c(2, 3, 4, 5, 8, 9, 10, 11, 12, 13, 14, 35, 37, 38, 40, 41)]

miss_forest <- world_joined_df %>%
  select(all_of(top_economic_correlated_variables), `Gold price (USD)`) %>%
  as.data.frame() %>%
  missForest(verbose = TRUE) 

print(miss_forest$OOBerror)

imputed_df <- miss_forest$ximp

train_index <- createDataPartition(imputed_df$`Gold price (USD)`, 
                                   p = .70, 
                                   list = FALSE)
train_data <- imputed_df[train_index,]
test_data <- imputed_df[-train_index,]

ctrl <- trainControl(method = "repeatedcv",
                     number = 5,
                     repeats = 5)

fit <- train(`Gold price (USD)` ~ .,
             data = train_data,
             method = "glmnet",
             trControl = ctrl)

varImp(fit)
```